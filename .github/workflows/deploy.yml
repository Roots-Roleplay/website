name: Deploy to Roots

on:
  push:  # Trigger on all branches
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy-main:
    runs-on: [self-hosted, ROOT394]
    if: >
      (github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/MAIN_'))) ||
      (github.event_name == 'workflow_dispatch')
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          submodules: recursive  # Fetch submodules as well

      - name: Build
        run: |
          Write-Output "Building project..."
          if (Test-Path -Path "package.json") {
            npm install
            npm run build
            Write-Output "Build completed successfully!"
          } else {
            Write-Output "No package.json found, skipping build step."
          }
        shell: powershell

      - name: Report build status
        run: |
          Write-Output "Build status: SUCCESS"
          Write-Output "Ready to deploy to server..."
        shell: powershell

      - name: Deploy files to server
        run: |
          $source = $env:GITHUB_WORKSPACE
          $target = 'C:\Roots\infrastructure\main\services\nginx\data\html\roots'
          
          Write-Output "=== COPYING FILES TO SERVER ==="
          Write-Output "Source: $source"
          Write-Output "Target: $target"
          
          # Create target directory if it doesn't exist
          if (-not (Test-Path -Path $target)) {
            New-Item -ItemType Directory -Path $target -Force
            Write-Output "Created target directory: $target"
          }
          
          # Copy all files except .git
          Write-Output "Copying files..."
          $exclude = @('.git', 'node_modules', '.github')
          Get-ChildItem -Path $source -Exclude $exclude | ForEach-Object {
            $destPath = Join-Path $target $_.Name
            if ($_.PSIsContainer) {
              Copy-Item -Path $_.FullName -Destination $destPath -Recurse -Force
            } else {
              Copy-Item -Path $_.FullName -Destination $destPath -Force
            }
          }
          
          Write-Output "Files copied successfully to: $target"
          $fileCount = (Get-ChildItem -Path $target -Recurse -File | Measure-Object).Count
          Write-Output "Total files in target: $fileCount"
        shell: powershell

      - name: Reload nginx
        run: |
          Write-Output "=== RELOADING NGINX ==="
          
          # Test nginx configuration before reloading
          Write-Output "Testing nginx configuration..."
          docker exec nginx_proxy_manager nginx -t
          
          if ($LASTEXITCODE -eq 0) {
            Write-Output "Configuration test passed. Reloading nginx..."
            docker exec nginx_proxy_manager nginx -s reload
            if ($LASTEXITCODE -eq 0) {
              Write-Output "✅ Nginx reloaded successfully!"
              Write-Output "✅ Server deployment complete!"
            } else {
              Write-Warning "Nginx reload failed with exit code $LASTEXITCODE"
              exit 1
            }
          } else {
            Write-Error "Nginx configuration test failed! Not reloading."
            exit 1
          }
        shell: powershell

  deploy-pages:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

